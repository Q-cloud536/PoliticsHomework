<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>码农的田地</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        game: ['"Press Start 2P"', 'cursive', 'sans-serif']
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .game-card {
                @apply bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-2 cursor-pointer;
            }
            .game-container {
                @apply absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-500;
            }
            .game-container.active {
                @apply opacity-100 pointer-events-auto;
            }
            .cell-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            
            /* 数字华容道方块样式 */
            .puzzle-cell {
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                border-radius: 0.5rem;
                position: relative;
            }
            
            /* 方块中的数字样式 */
            .cell-number {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 1.5rem;
                font-weight: bold;
                color: white;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
                z-index: 10;
                pointer-events: none; /* 确保数字不会阻挡点击事件 */
            }
            
            /* 为每个数字定义背景图片 */
            .cell-1 { background-image: url('../image/1.png'); }
            .cell-2 { background-image: url('../image/2.png'); }
            .cell-3 { background-image: url('../image/3.png'); }
            .cell-4 { background-image: url('../image/4.png'); }
            .cell-5 { background-image: url('../image/5.png'); }
            .cell-6 { background-image: url('../image/6.png'); }
            .cell-7 { background-image: url('../image/7.png'); }
            .cell-8 { background-image: url('../image/8.png'); }
            .cell-9 { background-image: url('../image/9.png'); }
            .cell-10 { background-image: url('../image/10.png'); }
            .cell-11 { background-image: url('../image/11.png'); }
            .cell-12 { background-image: url('../image/12.png'); }
            .cell-13 { background-image: url('../image/13.png'); }
            .cell-14 { background-image: url('../image/14.png'); }
            .cell-15 { background-image: url('../image/15.png'); }
            .pulse-animation {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            /* 挑战进度样式 */
            .challenge-progress {
                @apply fixed top-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-3;
            }
            .progress-dot {
                @apply w-3 h-3 rounded-full transition-all duration-300;
            }
            .progress-dot.current {
                @apply bg-primary scale-150;
            }
            .progress-dot.completed {
                @apply bg-secondary;
            }
            .progress-dot.upcoming {
                @apply bg-gray-300;
            }
            
            /* 完成挑战页面样式 */
            .completion-screen {
                @apply fixed inset-0 bg-gradient-to-br from-primary/95 to-blue-700/95 flex flex-col items-center justify-center z-50 p-4;
                display: none; /* 确保初始状态完全隐藏 */
            }
            .completion-content {
                @apply bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center;
            }
            .confetti {
                @apply absolute rounded-full opacity-80;
                animation: confetti-fall 5s linear infinite;
            }
            @keyframes confetti-fall {
                0% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
                100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
            }
            
            /* 节奏大师样式 */
			
            .note {
                position: absolute;
                width: 48px;
                height: 48px;
                /* 移除圆形样式，使用方形图片 */
                border-radius: 0;
                left: 50%;
                transform: translateX(-50%);
                will-change: top;
                pointer-events: none;
                z-index: 10;
                /* 确保背景图片正确显示 */
                background-color: transparent !important;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
            }
            .note .judge-zone {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                /* 移除视觉样式，只保留占位元素用于判定逻辑 */
                width: 0;
                height: 0;
                border: none;
                background: transparent;
                pointer-events: none;
            }
            .note .judge-zone.perfect {
                /* 保留判定逻辑但移除视觉样式 */
            }
            .note .judge-zone.good {
                /* 保留判定逻辑但移除视觉样式 */
            }
            @keyframes noteDisappear {
                0% { transform: translateX(-50%) scale(1); opacity: 1; }
                100% { transform: translateX(-50%) translateY(20px) scale(0.5); opacity: 0; }
            }
            .note-disappear {
                animation: noteDisappear 0.3s ease-out forwards !important;
            }
            @keyframes noteHit {
                0% { transform: translateX(-50%) scale(1); }
                50% { transform: translateX(-50%) scale(1.1); }
                100% { transform: translateX(-50%) scale(1); }
            }
            .note-hit {
                animation: noteHit 0.2s ease-in-out;
            }
            .judge-text {
                @apply absolute font-bold text-white text-lg opacity-0 transition-all duration-500;
            }
            @keyframes comboPulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
            .combo-pulse {
                animation: comboPulse 0.3s ease-in-out;
            }
            @keyframes judgePopup {
                0% { opacity: 1; transform: translateY(0); }
                70% { opacity: 1; }
                100% { opacity: 0; transform: translateY(-30px); }
            }
            .judge-popup {
                animation: judgePopup 1s ease-out forwards;
            }
            @keyframes judgePointPulse {
                0% { transform: scale(1); opacity: 0.8; }
                50% { transform: scale(1.3); opacity: 1; }
                100% { transform: scale(1); opacity: 0.8; }
            }
            .judge-point {
                width: 18px;
                height: 18px;
                border-radius: 50%;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                z-index: 21;
                box-shadow: 0 0 12px rgba(255,255,255,0.9);
            }
            #hit-line {
                background: linear-gradient(90deg, 
                    rgba(59,130,246,0.9) 0%, 
                    rgba(59,130,246,0.9) 25%, 
                    rgba(236,72,153,0.9) 25%, 
                    rgba(236,72,153,0.9) 50%, 
                    rgba(139,92,246,0.9) 50%, 
                    rgba(139,92,246,0.9) 75%, 
                    rgba(16,185,129,0.9) 75%, 
                    rgba(16,185,129,0.9) 100%);
                z-index: 20;
                box-shadow: 0 0 10px rgba(255,255,255,0.7);
                height: 4px;
                position: absolute;
                left: 0;
                right: 0;
            }
            .track {
                position: relative;
                flex: 1;
                border-right: 1px solid rgba(255,255,255,0.1);
                overflow: hidden;
            }
            .track:last-child {
                border-right: none;
            }
            .key-active {
                @apply scale-95 shadow-lg brightness-110;
            }
            
            /* 点击挑战样式 */
            .game-area-click {
                @apply relative w-full max-w-3xl h-[60vh] mx-auto rounded-xl shadow-lg overflow-hidden;
                touch-action: none;
                user-select: none;
                -webkit-user-drag: none;
                -webkit-touch-callout: none;
                min-height: 500px;
                min-width: 800px;
            }
            
            .game-area-click::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: url('../image/码地.jpg');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                opacity: 0.8;
                z-index: -1;
            }
            .target-square {
                @apply absolute w-16 h-16 cursor-pointer transition-all duration-150 transform hover:scale-110 active:scale-90;
				background-image: url('../image/Glow-0.png'); /* 替换为实际图片路径 */
				background-color: #22c55e; 
                background-size: cover; /* 图片覆盖整个方块，不拉伸变形 */
                background-position: center; /* 图片居中显示 */
                background-repeat: no-repeat; /* 防止图片重复 */
                touch-action: manipulation;
                user-select: none;
                -webkit-user-drag: none;
                -webkit-touch-callout: none;
            }
            .stats-display {
                @apply text-4xl md:text-5xl font-bold text-center my-6;
            }
            .timer-display {
                @apply text-xl md:text-2xl text-center mb-4 text-gray-600;
            }
            .best-score {
                @apply text-lg text-center text-gray-500 mt-2;
            }
            .game-message {
                @apply absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold text-gray-600 opacity-0 transition-opacity duration-500;
            }
            
            /* 打地鼠游戏样式 */
            .square {
                @apply w-48 h-48 md:w-64 md:h-64 rounded-lg cursor-pointer transition-all duration-150 ease-out shadow-lg;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
            }
            .square-normal {
                @apply bg-gray-300 hover:bg-gray-400;
                background-image: none !important; /* 非激活状态下不显示图片 */
            }
            .square-active {
                background: transparent;
                position: relative;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }
            .square-clicked {
                @apply bg-gray-300 scale-95;
            }
            .whack-a-mole-container {
                @apply grid grid-cols-2 gap-6 md:gap-8 max-w-3xl mx-auto;
            }
            .score-display-whack {
                @apply text-2xl md:text-3xl font-bold text-dark;
            }
            .timer-display-whack {
                @apply text-xl md:text-2xl font-semibold text-secondary;
            }
            .start-button {
                @apply bg-secondary hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50 active:scale-95;
            }
            .restart-button {
                @apply bg-primary hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50;
            }
            .game-over-modal {
                @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
            }
            .game-over-content {
                @apply bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full mx-4;
            }
            
            /* 打字练习游戏样式 */
            .typing-container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .target-text {
                line-height: 1.6;
                margin-bottom: 25px;
                padding: 20px;
                background-color: #fafafa;
                border-radius: 6px;
                color: #999;
                font-size: 16px;
                white-space: pre-wrap;
            }
            .input-area {
                margin-bottom: 25px;
            }
            #typing-input {
                width: 100%;
                height: 180px;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 16px;
                line-height: 1.6;
                resize: none;
                outline: none;
                transition: border-color 0.3s;
            }
            #typing-input:focus {
                border-color: #4285f4;
                box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
            }
            .stats {
                display: flex;
                justify-content: space-between;
                font-size: 18px;
                color: #333;
            }
            .time-display, .record-display {
                font-weight: bold;
            }
            .correct {
                color: #0f9d58;
            }
            .error {
                color: #d93025;
                text-decoration: underline wavy #d93025;
            }
            .remaining {
                color: #999;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen font-sans text-gray-800 p-4" style="position: relative;">
<style type="text/tailwindcss">
        @layer utilities {
            .puzzle-background-overlay {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('../image/旱灾背景.png');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                z-index: -1;
                pointer-events: none;
            }
            
            .click-background-overlay {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('../image/码地背景.png');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                opacity: 0.5;
                z-index: -1;
                pointer-events: none;
            }
            
            .typing-background-overlay {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('../image/耕耘背景.png');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                opacity: 0.8;
                z-index: -1;
                pointer-events: none;
            }
            
            .rhythm-background-overlay {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('../image/音游背景.png');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                opacity: 0.5;
                z-index: -1;
                pointer-events: none;
            }
            
            .whack-background-overlay {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('../image/倒霉娃背景.png');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                z-index: -1;
                pointer-events: none;
            }
        }
    </style>
    <!-- 挑战进度指示器 -->
    <div class="challenge-progress">
        <span class="font-semibold text-primary">节气快：</span>
        <div class="flex gap-2">
            <div class="progress-dot current" data-step="1"></div>
            <div class="progress-dot upcoming" data-step="2"></div>
            <div class="progress-dot upcoming" data-step="3"></div>
            <div class="progress-dot upcoming" data-step="4"></div>
            <div class="progress-dot upcoming" data-step="5"></div>
            <div class="progress-dot upcoming" data-step="6"></div>
            <div class="progress-dot upcoming" data-step="7"></div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="max-w-6xl mx-auto relative min-h-[70vh]">
        <!-- 所有游戏容器 -->
        <div id="puzzle-game" class="game-container mt-12 md:mt-16">
			<h1 class="puzzle-title text-center text-2xl font-bold text-gray-800 mb-4">ATTENTION!!!遭遇旱灾！！！</h1>
            <div class="puzzle-background-overlay"></div>
            <div class="flex flex-col md:flex-row gap-6 items-center max-w-3xl mx-auto">
                <!-- 游戏棋盘 -->
                <div class="relative w-full max-w-sm">
                    <div id="puzzle-container" class="w-full aspect-square bg-white rounded-xl shadow-xl p-4 md:p-6 overflow-hidden">
                        <div id="game-board" class="w-full h-full grid grid-cols-4 gap-0.5"></div>
                    </div>
                    <!-- 加载动画 -->
                    <div id="loading-overlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm rounded-xl flex items-center justify-center z-10">
                        <div class="text-center">
                            <div class="inline-block w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p class="text-primary font-medium">游戏加载中...</p>
                        </div>
                    </div>
                    <!-- 胜利提示 -->
                    <div id="win-message" class="hidden absolute inset-0 bg-gray-900/90 backdrop-blur-sm rounded-xl flex flex-col items-center justify-center z-20 text-white">
                        <div class="text-center p-6">
                            <i class="fa fa-trophy text-accent text-5xl mb-4 pulse-animation"></i>
                            <h3 class="text-2xl font-bold mb-2">南码北调成功！恭喜你渡过旱灾！</h3>
                            <p id="win-stats" class="mb-6 text-gray-300"></p>
                            <button id="play-again" class="bg-accent hover:bg-accent/90 text-white font-semibold py-2 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 next-game-button">
                                下一节气快
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 游戏信息和控制 -->
                <div class="w-full max-w-sm bg-white rounded-xl shadow-lg p-6 flex flex-col gap-6">
                    <!-- 游戏状态 -->
                    <div class="grid grid-cols-2 gap-4">
						
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-gray-500 text-sm mb-1">时间</p>
                            <p id="timer" class="text-2xl font-bold text-primary">00:00</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-gray-500 text-sm mb-1">步数</p>
                            <p id="moves" class="text-2xl font-bold text-secondary">0</p>
                        </div>
                    </div>

                    <!-- 最高记录 -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-gray-500 text-sm mb-1">最高记录</p>
                        <p id="best-record" class="text-xl font-bold text-accent">--:-- (--步)</p>
                    </div>

                    <!-- 游戏控制 -->
                    <div class="flex flex-col gap-3">
                        <button id="start-game" class="flex items-center justify-center space-x-2 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors shadow-md">
                            <i class="fa fa-play"></i>
                            <span>开始游戏</span>
                        </button>
                        <button id="reset-game" class="flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">
                            <i class="fa fa-refresh"></i>
                            <span>重新开始</span>
                        </button>
                        <button id="hint-button" class="flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">
                            <i class="fa fa-lightbulb-o"></i>
                            <span>提示</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 节奏大师游戏（修复版） -->
        <div id="rhythm-game" class="game-container mt-12 md:mt-16">
            <div class="rhythm-background-overlay"></div>
            <div id="game-container-rhythm" class="relative w-full max-w-4xl mx-auto flex flex-col min-h-[80vh]">
                <!-- 开始菜单 -->
                <div id="start-menu" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/95 z-50 transition-opacity duration-5000">
                    <h1 class="text-[clamp(2rem,5vw,4rem)] font-game text-primary mb-8">不好！！！码地遭遇洪涝</h1>
                    
                    <div class="flex flex-col items-center gap-4 w-full max-w-md">
                        <button id="start-button" class="bg-primary hover:bg-primary/80 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 w-full max-w-xs">
                            开始游戏
                        </button>
                        
                        <div class="mt-8 text-center">
                            <p class="text-light/70 mb-2">当物体碰到判定线时按下对应按键</p>
                            <div class="flex justify-center gap-4">
                                <div class="bg-dark border-2 border-primary rounded p-2 w-12 h-12 flex items-center justify-center font-bold text-white">D</div>
                                <div class="bg-dark border-2 border-secondary rounded p-2 w-12 h-12 flex items-center justify-center font-bold text-white">F</div>
                                <div class="bg-dark border-2 border-accent rounded p-2 w-12 h-12 flex items-center justify-center font-bold text-white">J</div>
                                <div class="bg-dark border-2 border-success rounded p-2 w-12 h-12 flex items-center justify-center font-bold text-white">K</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 游戏界面 -->
                <div id="game-screen" class="flex flex-col h-[80vh] hidden">
                    <!-- 游戏信息区 -->
                    <div class="flex justify-between items-center p-4 bg-dark/80 backdrop-blur-sm border-b border-light/10 z-30">
                        <div class="flex gap-8">
                            <div>
                                <p class="text-light/70 text-sm">分数</p>
                                <p id="score" class="text-2xl font-bold text-primary">0</p>
                            </div>
                            <div>
                                <p class="text-light/70 text-sm">连击</p>
                                <p id="combo" class="text-2xl font-bold text-secondary">0</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-light/70 text-sm">时间</p>
                            <p id="time" class="text-2xl font-bold text-accent">00:00</p>
                        </div>
                    </div>
                    
                    <!-- 游戏主区域 -->
                    <div id="game-area" class="flex-1 relative overflow-hidden">
                        <!-- 小人头像容器 -->
                        <div id="avatar-container" class="absolute bottom-4 left-4 z-30 w-24 h-24">
                            <img id="avatar-image" src="../image/小人1.png" alt="Game Character" class="w-full h-full object-contain">
                        </div>
                        <!-- 判定线 -->
                        <div id="hit-line"></div>
                        
                        <!-- 判定点容器 -->
                        <div id="judge-points-container" class="absolute w-full z-21">
                            <div class="judge-point bg-primary" data-track="0"></div>
                            <div class="judge-point bg-secondary" data-track="1"></div>
                            <div class="judge-point bg-accent" data-track="2"></div>
                            <div class="judge-point bg-success" data-track="3"></div>
                        </div>
                        
                        <!-- 轨道容器 -->
                        <div id="tracks-container" class="absolute inset-0 flex">
                            <div class="track" data-track="0"></div>
                            <div class="track" data-track="1"></div>
                            <div class="track" data-track="2"></div>
                            <div class="track" data-track="3"></div>
                        </div>
                    </div>
                    
                    <!-- 按键区域 -->
                    <div id="key-area" class="h-36 flex z-30 justify-around items-center" style="background-image: url('../image/判定区域.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
                        <div class="key-container" data-key="d" data-track="0">
                            <div class="judge-display"></div>
                            <div class="key w-16 h-16 rounded-lg bg-primary border-2 border-primary flex items-center justify-center text-2xl font-bold text-white">D</div>
                        </div>
                        <div class="key-container" data-key="f" data-track="1">
                            <div class="judge-display"></div>
                            <div class="key w-16 h-16 rounded-lg bg-secondary border-2 border-secondary flex items-center justify-center text-2xl font-bold text-white">F</div>
                        </div>
                        <div class="key-container" data-key="j" data-track="2">
                            <div class="judge-display"></div>
                            <div class="key w-16 h-16 rounded-lg bg-accent border-2 border-accent flex items-center justify-center text-2xl font-bold text-white">J</div>
                        </div>
                        <div class="key-container" data-key="k" data-track="3">
                            <div class="judge-display"></div>
                            <div class="key w-16 h-16 rounded-lg bg-danger border-2 border-danger flex items-center justify-center text-2xl font-bold text-white">K</div>
                        </div>
                    </div>
                </div>
                
                <!-- 游戏结束界面 -->
                <div id="game-over" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/95 z-40 hidden">
                    <h2 class="text-3xl font-game text-danger mb-4">恭喜你渡过洪涝</h2>
                    <div class="bg-dark/50 backdrop-blur-md p-8 rounded-xl border border-light/10 mb-6 w-full max-w-md">
                        <div class="flex justify-between mb-4 pb-4 border-b border-light/10">
                            <span class="text-white">最终得分</span>
                            <span id="final-score" class="font-bold text-primary text-xl">0</span>
                        </div>
                        <div class="flex justify-between mb-4 pb-4 border-b border-light/10">
                            <span class="text-white">最高连击</span>
                            <span id="max-combo" class="font-bold text-secondary text-xl">0</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-white">
                                <span class="text-success">Perfect:</span>
                                <span id="perfect-count" class="ml-2">0</span>
                            </div>
                            <div class="text-white">
                                <span class="text-warning">Good:</span>
                                <span id="good-count" class="ml-2">0</span>
                            </div>
                            <div class="text-white">
                                <span class="text-danger">Miss:</span>
                                <span id="miss-count" class="ml-2">0</span>
                            </div>
                            <div class="text-white">
                                <span class="text-accent">准确率:</span>
                                <span id="accuracy" class="ml-2">0%</span>
                            </div>
                        </div>
                    </div>
                    <button id="restart-button" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 active:scale-95 next-game-button">
                        下一节气快
                    </button>
                </div>
            </div>
        </div>

        <!-- 点击方块挑战游戏 -->
        <div id="click-game" class="game-container" style="touch-action: manipulation;">
            <div class="click-background-overlay"></div>
            <div class="w-full max-w-3xl mx-auto">
                <h1 class="text-3xl md:text-4xl font-bold text-center my-6 text-dark">开始播种</h1>
                
                <!-- 游戏状态显示 -->
                <div id="score-display" class="stats-display text-primary">0/64</div>
                
                <!-- 计时器显示 -->
                <div id="timer-display-click" class="timer-display">
                    <i class="fa fa-clock-o mr-2"></i>时间: <span id="time-click">0.000</span>秒
                </div>
                
                <!-- 最佳记录显示 -->
                <div id="best-score-click" class="best-score">
                    <i class="fa fa-trophy text-accent mr-2"></i>最佳记录: <span id="best-time-click">--</span>秒
                </div>
                
                <!-- 游戏区域 -->
                <div id="game-area-click" class="game-area-click">
                    <!-- 开始提示 -->
                    <div id="start-message" class="game-message opacity-100">点击开始游戏</div>
                    <!-- 方块会动态生成在这里 -->
                    <div id="complete-message" class="game-message">播种完成！</div>
                </div>
                
                <!-- 下一个游戏按钮 -->
                <div class="text-center mt-8">
                    <button id="next-click-game" class="next-game-button hidden bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        下一节气快
                    </button>
                </div>
            </div>
        </div>

        <!-- 打地鼠游戏 -->
        <div id="whack-a-mole" class="game-container mt-12 md:mt-16">
            <div class="whack-background-overlay"></div>
            <!-- 倒霉娃元素图片 -->
            <img id="daomeiwa-element" class="fixed bottom-4 left-4 w-112 h-auto z-10" src="../image/倒霉娃元素.png" alt="倒霉娃元素">
            <div class="text-center mb-4" style="position: relative; z-index: 10;">
                <h1 class="text-2xl font-bold text-dark mb-2">隔壁家的倒霉娃子</h1>
                <p class="text-gray-600 text-lg md:text-xl font-medium">何以救地？唯有作业！</p>
            </div>
            
            <div class="flex justify-between items-center w-full max-w-3xl mb-8 mx-auto" style="position: relative; z-index: 10;">
                <div class="score-display-whack">
                    <i class="fa fa-star text-secondary mr-2"></i>
                    <span id="score-whack">0</span>/<span id="target-whack">64</span>
                </div>
                <div class="timer-display-whack">
                    <i class="fa fa-clock-o mr-2"></i>
                    <span id="time-whack">32</span>秒
                </div>
            </div>
            
            <div class="whack-a-mole-container mb-8" style="position: relative; z-index: 10;">
                <div id="square-0" class="square square-normal" style="background-image: url('../image/打地鼠1.png');"></div>
                <div id="square-1" class="square square-normal" style="background-image: url('../image/打地鼠2.png');"></div>
                <div id="square-2" class="square square-normal" style="background-image: url('../image/打地鼠3.png');"></div>
                <div id="square-3" class="square square-normal" style="background-image: url('../image/打地鼠4.jpg');"></div>
            </div>
            
            <div class="flex justify-center" style="position: relative; z-index: 10;">
                <button id="start-button-whack" class="start-button">
                    <i class="fa fa-play mr-2"></i>开始游戏
                </button>
            </div>
            <!-- 游戏结束弹窗 -->
            <div id="game-over-modal-whack" class="game-over-modal hidden" style="display: none; z-index: 20;">
                <div class="game-over-content">
                    <h2 class="text-3xl font-bold text-dark mb-4">恭喜你，倒霉娃子正在奋笔疾书！</h2>
                    <p class="text-xl mb-2">你的得分：<span id="final-score-whack" class="font-bold text-primary">0</span>/64</p>
                    <p id="result-message-whack" class="text-lg mb-6"></p>
                    <button id="restart-button-whack" class="restart-button next-game-button">
                        <i class="fa fa-refresh mr-2"></i>下一节气快
                    </button>
                </div>
            </div>
        </div>

        <!-- 打字练习游戏 -->
        <div id="typing-practice" class="game-container mt-12 md:mt-16">
            <div class="typing-background-overlay"></div>
            <div class="text-center mb-4">
                <h1 class="text-2xl font-bold text-dark mb-2">开始耕耘</h1>
                <p class="text-gray-600 text-lg md:text-xl font-medium">快速输入《共产党宣言》，加油耕耘吧！（ps:复制是没用的，不信你试试）</p>
            </div>
			
			<!-- 新增视频元素 -->
    <video id="typing-video" class="fixed bottom-4 left-4 w-96 h-auto z-10" autoplay loop muted playsinline>
        <source src="../image/耕耘.mp4" type="video/mp4">
        你的浏览器不支持视频播放
    </video>
            
            <div class="typing-container">
                <!-- 目标练习文本 -->
                <div class="target-text" id="target-text">
                    All previous historical movements were movements of minorities, or in the interest of minorities. The proletarian movement is the self-conscious, independent movement of the immense majority, in the interest of the immense majority. The proletariat, the lowest stratum of our present society, cannot stir, cannot raise itself up, without the whole super incumbent strata of official society being sprung into the air.
                </div>

                <!-- 打字输入框 -->
                <div class="input-area">
                    <textarea 
                        id="typing-input" 
                        placeholder="点击此处开始输入..." 
                        onpaste="return false" 
                        oncut="return false" 
                        oncopy="return false"
                    ></textarea>
                </div>

                <!-- 统计信息 -->
                <div class="stats">
                    <div class="time-display">当前用时: <span id="current-time">00:00.00</span></div>
                    <div class="record-display">最快纪录: <span id="best-record-typing">--:--.--</span></div>
                </div>
            </div>
            
            <!-- 下一个游戏按钮 -->
            <div class="text-center mt-8">
                <button id="next-typing-game" class="next-game-button hidden bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                    下一节气快
                </button>
            </div>
        </div>
            </div>

    <!-- 完成七次游戏页面 -->
    <div id="completion-screen" class="completion-screen">
        <!-- 庆祝彩屑 -->
        <div id="confetti-container"></div>
        
        <div class="completion-content">
            <div class="text-accent text-6xl mb-6">
                <i class="fa fa-trophy pulse-animation"></i>
            </div>
            <h2 class="text-3xl font-bold text-dark mb-4">第八节气快：收获</h2>
            <p class="text-gray-600 mb-8">你已成功完成七个节气快的码地，太棒了！</p>
            <div class="flex gap-4">
                <button id="restart-challenge" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 flex-1">
                    再次挑战
                </button>
                <a id="view-stats" href="multi-games-score.html" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 flex-1 text-center">
                    查看码地明细
                </a>
            </div>
        </div>
    </div>

    <script>
        // 七次游戏挑战逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 挑战状态
            const challengeState = {
                currentGame: null,
                completedGames: 0,
                totalGames: 7,
                // 定义后面6个游戏的概率分布（不包含点击游戏）
                gameProbabilities: [
                    { game: 'puzzle', probability: 0.1},    // 数字华容道 10%
                    { game: 'rhythm', probability: 0.1},    // 节奏大师 10%
                    { game: 'whack-a-mole', probability: 0.2}, // 打地鼠 20%
                    { game: 'typing-practice', probability: 0.6} // 打字游戏 60%
                ],
                history: []
            };
            
            // 游戏容器
            const gameContainers = {
                'puzzle': document.getElementById('puzzle-game'),
                'rhythm': document.getElementById('rhythm-game'),
                'click': document.getElementById('click-game'),
                'whack-a-mole': document.getElementById('whack-a-mole'),
                'typing-practice': document.getElementById('typing-practice')
            };
            
            // 根据概率随机选择游戏
            function getGameByProbability() {
                // 生成0到1之间的随机数
                const random = Math.random();
                let cumulativeProbability = 0;
                
                // 遍历概率分布，找到随机数所在的区间
                for (const { game, probability } of challengeState.gameProbabilities) {
                    cumulativeProbability += probability;
                    if (random < cumulativeProbability) {
                        return game;
                    }
                }
                
                // 作为后备，返回最后一个游戏
                return challengeState.gameProbabilities[challengeState.gameProbabilities.length - 1].game;
            }
            
            // 初始化挑战
            function initChallenge() {
                // 重置挑战状态
                challengeState.currentGame = null;
                challengeState.completedGames = 0;
                challengeState.history = [];
                
                // 清空本次挑战的分数记录
                clearMultiGameScores();
                
                // 重置进度指示器
                updateProgressIndicator();
                
                // 确保完成页面隐藏
                document.getElementById('completion-screen').style.display = 'none';
                
                // 开始第一个游戏 - 固定为点击游戏
                startFirstGame();
            }

            // 在挑战开始时清空本地分数数组
            function clearMultiGameScores() {
                try {
                    localStorage.setItem('multi_game_scores', JSON.stringify([]));
                } catch (e) {
                    console.warn('无法清空 multi_game_scores', e);
                }
            }
            
            // 开始第一个游戏 - 固定为点击挑战
            function startFirstGame() {
                // 隐藏所有游戏
                Object.values(gameContainers).forEach(container => {
                    container.classList.remove('active');
                });
                
                // 第一个游戏固定为点击挑战
                const firstGame = 'click';
                
                // 更新当前游戏
                challengeState.currentGame = firstGame;
                challengeState.history.push(firstGame);
                
                // 显示并初始化点击游戏
                gameContainers[firstGame].classList.add('active');
                resetAndStartGame(firstGame);
            }
            
            // 选择并开始下一个游戏（按指定概率）
            function startNextGame() {
                // 检查是否完成所有游戏
                if (challengeState.completedGames >= challengeState.totalGames) {
                    completeChallenge();
                    return;
                }
                
                // 隐藏所有游戏
                Object.values(gameContainers).forEach(container => {
                    container.classList.remove('active');
                });
                
                let nextGame;
                
                // 从第二个游戏开始使用概率选择
                do {
                    // 根据概率分布选择游戏
                    nextGame = getGameByProbability();
                    
                    // 如果选择的游戏与上一个相同，有70%的概率重新选择（降低连续出现同一游戏的概率）
                    if (challengeState.history.length > 0 && 
                        nextGame === challengeState.history[challengeState.history.length - 1] && 
                        Math.random() < 0.7) {
                        continue; // 重新选择
                    }
                    
                    break;
                } while (true);
                
                // 更新当前游戏
                challengeState.currentGame = nextGame;
                challengeState.history.push(nextGame);
                
                // 显示并初始化选中的游戏
                gameContainers[nextGame].classList.add('active');
                resetAndStartGame(nextGame);
            }
            
            // 重置并开始指定游戏
            function resetAndStartGame(game) {
                // 重置游戏状态
                resetGameState(game);
                
                // 初始化并启动游戏
                initializeSelectedGame(game);
            }
            
            // 重置游戏状态
            function resetGameState(game) {
                switch(game) {
                    case 'puzzle':
                        // 重置华容道游戏
                        if (window.puzzleGameState) {
                            window.puzzleGameState.moves = 0;
                            window.puzzleGameState.timer = 0;
                            window.puzzleGameState.isPlaying = false;
                            stopPuzzleTimer();
                            document.getElementById('moves').textContent = '0';
                            document.getElementById('timer').textContent = '00:00';
                            document.getElementById('win-message').classList.add('hidden');
                        }
                        break;
                    case 'rhythm':
                        // 重置节奏大师游戏
                        if (window.rhythmGameState) {
                            window.rhythmGameState.isPlaying = false;
                            window.rhythmGameState.score = 0;
                            window.rhythmGameState.combo = 0;
                            window.rhythmGameState.maxCombo = 0;
                            window.rhythmGameState.time = 0;
                            window.rhythmGameState.notes.clear();
                            window.rhythmGameState.judgeCounts = {
                                perfect: 0,
                                good: 0,
                                miss: 0
                            };
                            
                            if (window.rhythmGameState.timer) {
                                clearInterval(window.rhythmGameState.timer);
                            }
                            if (window.rhythmGameState.animationFrameId) {
                                cancelAnimationFrame(window.rhythmGameState.animationFrameId);
                            }
                            
                            document.getElementById('game-screen').classList.add('hidden');
                            document.getElementById('start-menu').classList.remove('hidden', 'opacity-0');
                            document.getElementById('game-over').classList.add('hidden');
                            document.querySelectorAll('.note').forEach(note => note.remove());
                        }
                        break;
                    case 'click':
                        // 重置点击挑战游戏
                        if (window.clickGameState) {
                            window.clickGameState.currentScore = 0;
                            window.clickGameState.gameStarted = false;
                            window.clickGameState.currentTime = 0;
                            
                            if (window.clickGameState.timerInterval) {
                                clearInterval(window.clickGameState.timerInterval);
                            }
                            
                            document.getElementById('score-display').textContent = '0/64';
                            document.getElementById('time-click').textContent = '0.000';
                            document.getElementById('start-message').style.opacity = '1';
                            document.getElementById('complete-message').style.opacity = '0';
                            document.getElementById('next-click-game').classList.add('hidden');
                            
                            // 移除目标方块
                            if (window.clickGameState.target) {
                                window.clickGameState.target.remove();
                                window.clickGameState.target = null;
                            }
                        }
                        break;
                    case 'whack-a-mole':
                        // 重置打地鼠游戏
                        if (window.whackGameState) {
                            window.whackGameState.isPlaying = false;
                            window.whackGameState.score = 0;
                            window.whackGameState.timeLeft = 32;
                            window.whackGameState.activeSquares = [];
                            
                            if (window.whackGameState.timerInterval) {
                                clearInterval(window.whackGameState.timerInterval);
                            }
                            if (window.whackGameState.spawnInterval) {
                                clearInterval(window.whackGameState.spawnInterval);
                            }
                            
                            document.getElementById('score-whack').textContent = '0';
                            document.getElementById('time-whack').textContent = '32';
                            document.getElementById('start-button-whack').classList.remove('hidden');
                            document.getElementById('game-over-modal-whack').classList.add('hidden');
                            document.getElementById('game-over-modal-whack').style.display = 'none';
                            
                            // 重置所有方块
                            document.querySelectorAll('.square').forEach(square => {
                                square.classList.remove('square-active');
                                square.classList.add('square-normal');
                                square.style.backgroundColor = '';
                                square.style.boxShadow = '';
                            });
                        }
                        break;
                    case 'typing-practice':
                        // 重置打字练习游戏
                        if (window.typingGameState) {
                            window.typingGameState.startTime = null;
                            window.typingGameState.isTyping = false;
                            
                            if (window.typingGameState.timerInterval) {
                                clearInterval(window.typingGameState.timerInterval);
                            }
                            
                            document.getElementById('typing-input').value = '';
                            document.getElementById('typing-input').disabled = false;
                            document.getElementById('current-time').textContent = '00:00.00';
                            document.getElementById('next-typing-game').classList.add('hidden');
                            
                            // 重置文本高亮
                            if (window.updateTextHighlight) {
                                window.updateTextHighlight();
                            }
                        }
                        break;
                }
            }
            
            // 初始化选中的游戏
            function initializeSelectedGame(game) {
                switch(game) {
                    case 'puzzle':
                        // 初始化并自动开始华容道游戏
                        initPuzzleGame();
                        setTimeout(() => {
                            document.getElementById('start-game').click();
                        }, 500);
                        break;
                    case 'rhythm':
                        // 初始化并自动开始节奏大师游戏
                        initRhythmGame();
                        initRhythmGameUI();
                        setTimeout(() => {
                            document.getElementById('start-button').click();
                        }, 500);
                        break;
                    case 'click':
                        // 初始化点击挑战游戏
                        initClickGame();
                        // 隐藏下一个游戏按钮
                        document.getElementById('next-click-game').classList.add('hidden');
                        // 自动创建第一个目标
                        setTimeout(() => {
                            const startMessage = document.getElementById('start-message');
                            if (startMessage.style.opacity === '1') {
                                document.getElementById('game-area-click').click();
                            }
                        }, 300);
                        break;
                    case 'whack-a-mole':
                        // 初始化并自动开始打地鼠游戏
                        initWhackAMole();
                        setTimeout(() => {
                            document.getElementById('start-button-whack').click();
                        }, 500);
                        break;
                    case 'typing-practice':
                        // 初始化打字练习游戏
                        initTypingPractice();
                        // 隐藏下一个游戏按钮
                        document.getElementById('next-typing-game').classList.add('hidden');
                        // 自动聚焦输入框
                        setTimeout(() => {
                            document.getElementById('typing-input').focus();
                        }, 300);
                        break;
                }
            }
            
            // 更新进度指示器
            function updateProgressIndicator() {
                const dots = document.querySelectorAll('.progress-dot');
                
                dots.forEach((dot, index) => {
                    const step = index + 1;
                    
                    if (step < challengeState.completedGames + 1) {
                        dot.classList.remove('current', 'upcoming');
                        dot.classList.add('completed');
                    } else if (step === challengeState.completedGames + 1) {
                        dot.classList.remove('completed', 'upcoming');
                        dot.classList.add('current');
                    } else {
                        dot.classList.remove('completed', 'current');
                        dot.classList.add('upcoming');
                    }
                });
            }
            
            // 完成当前游戏
            function completeCurrentGame() {
                // 记录本轮分数
                try {
                    const game = challengeState.currentGame;
                    const score = computeCurrentGameScore(game);
                    pushRoundScore(game, score);
                } catch (e) {
                    console.warn('记录本轮分数出错', e);
                }

                challengeState.completedGames++;
                updateProgressIndicator();

                // 延迟开始下一个游戏，让玩家有时间看到结果
                setTimeout(() => {
                    startNextGame();
                }, 1000);
            }

            // 计算当前游戏分数（不同游戏使用不同策略）
            function computeCurrentGameScore(game) {
                switch (game) {
                    case 'puzzle': {
                        const t = window.puzzleGameState ? window.puzzleGameState.timer : 0;
                        const m = window.puzzleGameState ? window.puzzleGameState.moves : 0;
                        // 时间越短、步数越少分数越低，最高分128
                        // 基础分为128，时间每秒扣0.5分，步数每步扣0.1分
                        const baseScore = 128;
                        const timePenalty = t * 0.5;
                        const movePenalty = m * 0.1;
                        const score = baseScore - timePenalty - movePenalty;
                        return Math.max(0, Math.round(score * 100) / 100); // 保留两位小数，最低分50
                    }
                    case 'rhythm': {
                        // 准确度越高分数越高，最高分128
                        const gameState = window.rhythmGameState;
                        if (!gameState) return 0;
                        
                        // 基于准确率计算分数，最高128分
                        const totalNotes = gameState.judgeCounts.perfect + gameState.judgeCounts.good + gameState.judgeCounts.miss;
                        if (totalNotes === 0) return 0;
                        
                        // 准确率 = (Perfect + Good) / 总音符数
                        const accuracy = (gameState.judgeCounts.perfect + gameState.judgeCounts.good) / totalNotes;
                        
                        // 分数 = 准确率 * 100 + Perfect占比 * 28 (确保最高分128)
                        const perfectRatio = gameState.judgeCounts.perfect / totalNotes;
                        const score = Math.min(128, Math.round(accuracy * 100 + perfectRatio * 28));
                        
                        return Math.max(0, score);
                    }
                    case 'click': {
                        if (!window.clickGameState) return 0;
                        const time = window.clickGameState.currentTime || 0; // seconds
                        const baseScore = 128;
                        const score = baseScore - Math.max(0, Math.round((time - 128) * 0.5));
                        return Math.max(0, score);
                    }
                    case 'whack-a-mole': {
                        // 确保分数在0-128范围内
                        const rawScore = window.whackGameState ? (window.whackGameState.score || 0) : 0;
                        // 将分数映射到0-128范围，考虑到最多点击64次正确，最多点击若干次错误
                        // 假设最理想情况是64次全对，得分为64；最差情况是很多错误，得分为负数
                        // 我们将-64到64的范围映射到0到128
                        const normalizedScore = Math.max(0, Math.min(128, rawScore + 64));
                        return normalizedScore;
                    }
                    case 'typing-practice': {
                        // Use lastDuration (ms) saved when the typing round ends; fallback to best time or 0
                        let ms = 0;
                        if (window.typingGameState && window.typingGameState.lastDuration) {
                            ms = window.typingGameState.lastDuration;
                        } else if (localStorage.getItem('typingBestTime')) {
                            ms = Number(localStorage.getItem('typingBestTime'));
                        }
                        const seconds = ms / 1000;
                        const score = Math.max(0, Math.round(128 - seconds * 0.5));
                        return score;
                    }
                    default:
                        return 0;
                }
            }

            // 将本轮分数加入到 localStorage 的数组中
            function pushRoundScore(game, score) {
                try {
                    const raw = localStorage.getItem('multi_game_scores');
                    const arr = raw ? JSON.parse(raw) : [];
                    arr.push({ game: game, score: Math.min(128, Number(score || 0)) });
                    localStorage.setItem('multi_game_scores', JSON.stringify(arr));
                } catch (e) {
                    console.warn('无法保存 multi_game_scores', e);
                }
            }
            
            // 完成所有挑战
            function completeChallenge() {
                // 隐藏所有游戏
                Object.values(gameContainers).forEach(container => {
                    container.classList.remove('active');
                });
                
                // 显示完成页面（仅在完成所有7个游戏后）
                const completionScreen = document.getElementById('completion-screen');
                completionScreen.style.display = 'flex';
                
                // 创建庆祝彩屑
                createConfetti();

                // 自动跳转已移除，保留查看按钮供用户主动前往分数统计页面
            }
            
            // 创建庆祝彩屑效果
            function createConfetti() {
                const container = document.getElementById('confetti-container');
                container.innerHTML = ''; // 清空现有彩屑
                
                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                const count = 100;
                
                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.width = `${Math.random() * 20 + 10}px`;
                    confetti.style.height = confetti.style.width;
                    confetti.style.animationDelay = `${Math.random() * 5}s`;
                    confetti.style.opacity = Math.random() * 0.5 + 0.5;
                    container.appendChild(confetti);
                }
            }
            
            // 为所有"下一个游戏"按钮添加事件监听
            document.querySelectorAll('.next-game-button').forEach(button => {
                console.log('Attaching event listener to button:', button.id || button.className);
                button.addEventListener('click', function(event) {
                    console.log('Next game button clicked:', event.target.id || event.target.className);
                    completeCurrentGame();
                });
            });
            
            // 为点击挑战添加完成检测
            document.getElementById('game-area-click').addEventListener('click', function() {
                if (window.clickGameState && window.clickGameState.currentScore >= window.clickGameState.totalTargets) {
                    document.getElementById('next-click-game').classList.remove('hidden');
                }
            });
            
            // 为打字练习添加完成检测
            document.getElementById('typing-input').addEventListener('input', function() {
                const originalTargetText = document.getElementById('target-text').textContent.trim();
                if (this.value === originalTargetText) {
                    document.getElementById('next-typing-game').classList.remove('hidden');
                }
            });
            
            // 再次挑战按钮
            document.getElementById('restart-challenge').addEventListener('click', initChallenge);
            
            // 开始挑战
            initChallenge();
        });
        
        // 数字华容道游戏逻辑
        function initPuzzleGame() {
            // 防止重复初始化
            if (window.puzzleInitialized) return;
            window.puzzleInitialized = true;
            
            // 游戏状态变量
            window.puzzleGameState = {
                gridSize: 4,          // 固定为4x4
                board: [],            // 游戏板数据
                emptyCell: {x: 0, y: 0}, // 空白格子位置
                moves: 0,             // 移动步数
                timer: 0,             // 游戏时间(秒)
                timerInterval: null,  // 计时器
                isPlaying: false,     // 是否正在游戏
                bestRecord: {         // 最佳记录
                    time: null,
                    moves: null
                }
            };

            // DOM 元素
            const elements = {
                gameBoard: document.getElementById('game-board'),
                timerDisplay: document.getElementById('timer'),
                movesDisplay: document.getElementById('moves'),
                bestRecordDisplay: document.getElementById('best-record'),
                startButton: document.getElementById('start-game'),
                resetButton: document.getElementById('reset-game'),
                hintButton: document.getElementById('hint-button'),
                playAgainButton: document.getElementById('play-again'),
                loadingOverlay: document.getElementById('loading-overlay'),
                winMessage: document.getElementById('win-message'),
                winStats: document.getElementById('win-stats')
            };

            // 初始化
            function init() {
                // 加载保存的最佳记录
                loadBestRecord();
                
                // 更新最佳记录显示
                updateBestRecordDisplay();
                
                // 添加事件监听器
                addEventListeners();
                
                // 初始化游戏板但不开始游戏
                createBoard();
            }

            // 加载保存的最佳记录
            function loadBestRecord() {
                const savedRecord = localStorage.getItem('4x4PuzzleBestRecord');
                if (savedRecord) {
                    window.puzzleGameState.bestRecord = JSON.parse(savedRecord);
                }
            }

            // 保存最佳记录
            function saveBestRecord() {
                localStorage.setItem('4x4PuzzleBestRecord', JSON.stringify(window.puzzleGameState.bestRecord));
            }

            // 添加事件监听器
            function addEventListeners() {
                // 游戏控制按钮
                elements.startButton.addEventListener('click', startGame);
                elements.resetButton.addEventListener('click', resetGame);
                elements.hintButton.addEventListener('click', showHint);
                elements.playAgainButton.addEventListener('click', resetGame);
            }

            // 创建游戏板
            function createBoard() {
                elements.gameBoard.innerHTML = '';
                
                // 生成初始有序数组
                const totalCells = window.puzzleGameState.gridSize * window.puzzleGameState.gridSize;
                const numbers = Array.from({length: totalCells - 1}, (_, i) => i + 1);
                numbers.push(null); // 空白格
                
                // 打乱数组，但确保有解
                let shuffled;
                do {
                    shuffled = [...numbers];
                    // Fisher-Yates 洗牌算法
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }
                } while (!isSolvable(shuffled));
                
                // 构建游戏板并找到空白格位置
                window.puzzleGameState.board = [];
                for (let i = 0; i < window.puzzleGameState.gridSize; i++) {
                    const row = [];
                    for (let j = 0; j < window.puzzleGameState.gridSize; j++) {
                        const value = shuffled[i * window.puzzleGameState.gridSize + j];
                        row.push(value);
                        
                        if (value === null) {
                            window.puzzleGameState.emptyCell = {x: j, y: i};
                        }
                    }
                    window.puzzleGameState.board.push(row);
                }
                
                // 渲染游戏板
                renderBoard();
            }

            // 检查拼图是否有解
            function isSolvable(board) {
                const size = window.puzzleGameState.gridSize;
                let inversions = 0;
                const flatBoard = [...board];
                
                // 移除空白格
                const emptyIndex = flatBoard.indexOf(null);
                flatBoard.splice(emptyIndex, 1);
                
                // 计算逆序数
                for (let i = 0; i < flatBoard.length; i++) {
                    for (let j = i + 1; j < flatBoard.length; j++) {
                        if (flatBoard[i] > flatBoard[j]) {
                            inversions++;
                        }
                    }
                }
                
                // 对于偶数尺寸的棋盘，空白格所在的行数（从底部开始数）加上逆序数必须为奇数才有解
                const emptyRowFromBottom = size - Math.floor(emptyIndex / size);
                return (inversions + emptyRowFromBottom) % 2 === 1;
            }

            // 渲染游戏板
            function renderBoard() {
                elements.gameBoard.innerHTML = '';
                
                for (let y = 0; y < window.puzzleGameState.gridSize; y++) {
                    for (let x = 0; x < window.puzzleGameState.gridSize; x++) {
                        const cellValue = window.puzzleGameState.board[y][x];
                        const cell = document.createElement('div');
                        
                        // 基础样式
                        cell.className = 'flex items-center justify-center text-lg md:text-xl font-bold transition-all duration-200 cell-shadow puzzle-cell';
                        
                        if (cellValue === null) {
                            // 空白格
                            cell.className += ' bg-gray-100';
                            cell.dataset.empty = 'true';
                        } else {
                            // 数字格
                            cell.className += ` cell-${cellValue} cursor-pointer cell-hover`;
                            cell.dataset.x = x;
                            cell.dataset.y = y;
                            
                            // 添加数字显示
                            const numberElement = document.createElement('div');
                            numberElement.className = 'cell-number';
                            numberElement.textContent = cellValue;
                            cell.appendChild(numberElement);
                            
                            // 添加点击事件
                            cell.addEventListener('click', () => handleCellClick(x, y));
                        }
                        
                        elements.gameBoard.appendChild(cell);
                    }
                }
            }

            // 处理单元格点击
            function handleCellClick(x, y) {
                if (!window.puzzleGameState.isPlaying) return;
                
                // 检查是否与空白格相邻
                const isAdjacent = (
                    (Math.abs(x - window.puzzleGameState.emptyCell.x) === 1 && y === window.puzzleGameState.emptyCell.y) ||
                    (Math.abs(y - window.puzzleGameState.emptyCell.y) === 1 && x === window.puzzleGameState.emptyCell.x)
                );
                
                if (isAdjacent) {
                    // 更新步数
                    window.puzzleGameState.moves++;
                    updateMovesDisplay();
                    
                    // 交换位置
                    window.puzzleGameState.board[window.puzzleGameState.emptyCell.y][window.puzzleGameState.emptyCell.x] = window.puzzleGameState.board[y][x];
                    window.puzzleGameState.board[y][x] = null;
                    
                    // 更新空白格位置
                    window.puzzleGameState.emptyCell = {x, y};
                    
                    // 重新渲染
                    renderBoard();
                    
                    // 检查是否完成
                    if (isGameComplete()) {
                        endGame();
                    }
                }
            }

            // 检查游戏是否完成
            function isGameComplete() {
                const totalCells = window.puzzleGameState.gridSize * window.puzzleGameState.gridSize;
                
                for (let y = 0; y < window.puzzleGameState.gridSize; y++) {
                    for (let x = 0; x < window.puzzleGameState.gridSize; x++) {
                        // 最后一个格子应该是空白的
                        if (y === window.puzzleGameState.gridSize - 1 && x === window.puzzleGameState.gridSize - 1) {
                            return window.puzzleGameState.board[y][x] === null;
                        }
                        
                        // 其他格子应该按顺序排列
                        const expectedValue = y * window.puzzleGameState.gridSize + x + 1;
                        if (window.puzzleGameState.board[y][x] !== expectedValue) {
                            return false;
                        }
                    }
                }
                
                return true;
            }

            // 开始游戏
            function startGame() {
                if (window.puzzleGameState.isPlaying) return;
                
                // 显示加载动画
                elements.loadingOverlay.classList.remove('hidden');
                
                // 延迟创建棋盘，让加载动画有时间显示
                setTimeout(() => {
                    // 重置游戏状态
                    window.puzzleGameState.moves = 0;
                    window.puzzleGameState.timer = 0;
                    
                    // 更新显示
                    updateTimerDisplay();
                    updateMovesDisplay();
                    
                    // 创建新棋盘
                    createBoard();
                    
                    // 开始计时
                    startTimer();
                    
                    // 更新游戏状态
                    window.puzzleGameState.isPlaying = true;
                    
                    // 隐藏加载动画
                    elements.loadingOverlay.classList.add('hidden');
                }, 600);
            }

            // 重置游戏
            function resetGame() {
                // 停止计时器
                stopTimer();
                
                // 隐藏胜利消息
                elements.winMessage.classList.add('hidden');
                
                // 开始新游戏
                startGame();
            }

            // 开始计时器
            function startTimer() {
                // 先停止任何正在运行的计时器
                stopTimer();
                
                // 开始新的计时器
                window.puzzleGameState.timerInterval = setInterval(() => {
                    window.puzzleGameState.timer++;
                    updateTimerDisplay();
                }, 1000);
            }

            // 停止计时器
            function stopTimer() {
                if (window.puzzleGameState.timerInterval) {
                    clearInterval(window.puzzleGameState.timerInterval);
                    window.puzzleGameState.timerInterval = null;
                }
            }

            // 更新计时器显示
            function updateTimerDisplay() {
                const minutes = Math.floor(window.puzzleGameState.timer / 60);
                const seconds = window.puzzleGameState.timer % 60;
                elements.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // 更新步数显示
            function updateMovesDisplay() {
                elements.movesDisplay.textContent = window.puzzleGameState.moves;
            }

            // 更新最佳记录显示
            function updateBestRecordDisplay() {
                if (window.puzzleGameState.bestRecord.time === null) {
                    elements.bestRecordDisplay.textContent = '--:-- (--步)';
                } else {
                    const minutes = Math.floor(window.puzzleGameState.bestRecord.time / 60);
                    const seconds = window.puzzleGameState.bestRecord.time % 60;
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    elements.bestRecordDisplay.textContent = `${timeString} (${window.puzzleGameState.bestRecord.moves}步)`;
                }
            }

            // 游戏结束
            function endGame() {
                // 停止计时器
                stopTimer();
                
                // 更新游戏状态
                window.puzzleGameState.isPlaying = false;
                
                // 检查是否创造了新记录
                const isNewRecord = window.puzzleGameState.bestRecord.time === null || 
                                   window.puzzleGameState.timer < window.puzzleGameState.bestRecord.time ||
                                  (window.puzzleGameState.timer === window.puzzleGameState.bestRecord.time && window.puzzleGameState.moves < window.puzzleGameState.bestRecord.moves);
                
                if (isNewRecord) {
                    window.puzzleGameState.bestRecord.time = window.puzzleGameState.timer;
                    window.puzzleGameState.bestRecord.moves = window.puzzleGameState.moves;
                    saveBestRecord();
                    updateBestRecordDisplay();
                }
                
                // 显示胜利消息
                const timeString = elements.timerDisplay.textContent;
                elements.winStats.textContent = `用时: ${timeString} | 步数: ${window.puzzleGameState.moves} ${isNewRecord ? '| 新纪录！' : ''}`;
                elements.winMessage.classList.remove('hidden');
            }

            // 显示提示
            function showHint() {
                if (!window.puzzleGameState.isPlaying) return;
                
                // 简单提示：高亮可移动的方块
                const cells = elements.gameBoard.querySelectorAll('div:not([data-empty="true"])');
                
                cells.forEach(cell => {
                    const x = parseInt(cell.dataset.x);
                    const y = parseInt(cell.dataset.y);
                    
                    const isAdjacent = (
                        (Math.abs(x - window.puzzleGameState.emptyCell.x) === 1 && y === window.puzzleGameState.emptyCell.y) ||
                        (Math.abs(y - window.puzzleGameState.emptyCell.y) === 1 && x === window.puzzleGameState.emptyCell.x)
                    );
                    
                    if (isAdjacent) {
                        cell.classList.add('ring-4', 'ring-accent', 'pulse-animation');
                        
                        // 3秒后移除高亮
                        setTimeout(() => {
                            cell.classList.remove('ring-4', 'ring-accent', 'pulse-animation');
                        }, 3000);
                    }
                });
            }

            // 初始化游戏
            init();
        }
        
        // 停止华容道计时器（供外部调用）
        function stopPuzzleTimer() {
            if (window.puzzleGameState && window.puzzleGameState.timerInterval) {
                clearInterval(window.puzzleGameState.timerInterval);
                window.puzzleGameState.timerInterval = null;
            }
        }
        
        // 初始化节奏大师UI
        function initRhythmGameUI() {
            // 设置判定点动画
            const judgePoints = document.querySelectorAll('.judge-point');
            judgePoints.forEach(point => {
                point.style.animation = 'judgePointPulse 2s infinite';
            });
            
            // 确保游戏屏幕正确隐藏
            document.getElementById('game-screen').classList.add('hidden');
        }
        
        // 节奏大师游戏逻辑（修复版）
        function initRhythmGame() {
            // 防止重复初始化
            if (window.rhythmInitialized) return;
            window.rhythmInitialized = true;
            
            // 游戏状态和配置
            window.rhythmGameState = {
                isPlaying: false,
                score: 0,
                combo: 0,
                maxCombo: 0,
                time: 0,
                notes: new Map(), // 使用Map存储音符
                noteId: 0,
                judgeCounts: {
                    perfect: 0,
                    good: 0,
                    miss: 0
                },
                gameDuration: 20, // 游戏时间20秒
                spawnInterval: 700, // 音符生成间隔（毫秒）
                noteSpeed: 400, // 音符速度（像素/秒）
                lastSpawnTime: 0,
                lastFrameTime: 0, // 上一帧的时间戳
                timer: null,
                animationFrameId: null, // 用于存储动画帧ID
                trackCount: 4,
                keyMap: {
                    'd': 0,
                    'f': 1,
                    'j': 2,
                    'k': 3
                },
                keyColors: [
                    'bg-primary',
                    'bg-secondary',
                    'bg-accent',
                    'bg-success'
                ],
                hitLineY: 0, // 判定线Y坐标（相对于游戏区域）
                noteRadius: 24, // 音符半径（24px，直径48px）
                // 判定窗口（基于音符与判定线的交叉程度）
                hitWindow: {
                    perfect: 0.8, // 完美判定：音符80%以上越过判定线
                    good: 0.3    // 良好判定：音符30%以上越过判定线
                }
            };

            // DOM元素
            const elements = {
                startMenu: document.getElementById('start-menu'),
                gameScreen: document.getElementById('game-screen'),
                gameOver: document.getElementById('game-over'),
                startButton: document.getElementById('start-button'),
                restartButton: document.getElementById('restart-button'),
                scoreDisplay: document.getElementById('score'),
                comboDisplay: document.getElementById('combo'),
                timeDisplay: document.getElementById('time'),
                tracks: document.querySelectorAll('.track'),
                keyContainers: document.querySelectorAll('.key-container'),
                keys: document.querySelectorAll('.key'),
                hitLine: document.getElementById('hit-line'),
                judgePoints: document.querySelectorAll('.judge-point'),
                finalScore: document.getElementById('final-score'),
                maxCombo: document.getElementById('max-combo'),
                perfectCount: document.getElementById('perfect-count'),
                goodCount: document.getElementById('good-count'),
                missCount: document.getElementById('miss-count'),
                accuracy: document.getElementById('accuracy')
            };

            // 设置判定线和判定点位置
            function setupHitElements() {
                const keyArea = document.getElementById('key-area');
                const keyAreaRect = keyArea.getBoundingClientRect();
                const gameArea = document.getElementById('game-area');
                const gameAreaRect = gameArea.getBoundingClientRect();
                
                // 判定线位置：按键区域上方15px处
                window.rhythmGameState.hitLineY = keyAreaRect.top - 15 - gameAreaRect.top;
                elements.hitLine.style.top = `${window.rhythmGameState.hitLineY}px`;
                
                // 定位每个轨道的判定点
                const trackWidth = gameAreaRect.width / window.rhythmGameState.trackCount;
                elements.judgePoints.forEach((point, index) => {
                    const leftPos = (index * trackWidth) + (trackWidth / 2) - 9; // 居中18px宽的点
                    point.style.left = `${leftPos}px`;
                    point.style.top = `${window.rhythmGameState.hitLineY}px`;
                });
            }

            // 创建带判定区域标记的音符
            function createNoteWithJudgeZones(trackIndex) {
                // 创建音符容器
                const noteContainer = document.createElement('div');
                const noteId = `note-${window.rhythmGameState.noteId++}`;
                noteContainer.id = noteId;
                noteContainer.className = 'note';
                noteContainer.style.top = `-${window.rhythmGameState.noteRadius * 2}px`; // 从游戏区域顶部外开始
                
                // 根据轨道设置不同的背景图片
                const images = [
                    '../image/音游1.png',
                    '../image/音游2.png',
                    '../image/音游3.png',
                    '../image/音游4.png'
                ];
                
                // 设置背景图片
                noteContainer.style.backgroundImage = `url('${images[trackIndex]}')`;
                noteContainer.style.backgroundSize = 'cover';
                noteContainer.style.backgroundPosition = 'center';
                noteContainer.style.backgroundRepeat = 'no-repeat';
                
                // 创建完美判定区域标记（内圈）- 保留元素但移除视觉样式
                const perfectZone = document.createElement('div');
                perfectZone.className = 'judge-zone perfect';
                noteContainer.appendChild(perfectZone);
                
                // 创建良好判定区域标记（外圈）- 保留元素但移除视觉样式
                const goodZone = document.createElement('div');
                goodZone.className = 'judge-zone good';
                noteContainer.appendChild(goodZone);
                
                return {
                    element: noteContainer,
                    id: noteId
                };
            }

            // 初始化游戏
            function initGame() {
                // 确保清除之前的动画帧
                if (window.rhythmGameState.animationFrameId) {
                    cancelAnimationFrame(window.rhythmGameState.animationFrameId);
                }
                
                // 显示游戏屏幕
                elements.gameScreen.classList.remove('hidden');
                
                // 设置判定线和判定点
                setupHitElements();
                
                // 初始化小人头像
                initAvatar();
                
                // 重置游戏状态
                window.rhythmGameState.isPlaying = true;
                window.rhythmGameState.score = 0;
                window.rhythmGameState.combo = 0;
                window.rhythmGameState.maxCombo = 0;
                window.rhythmGameState.time = 0;
                window.rhythmGameState.notes.clear(); // 清空音符Map
                window.rhythmGameState.noteId = 0;
                window.rhythmGameState.judgeCounts = {
                    perfect: 0,
                    good: 0,
                    miss: 0
                };
                window.rhythmGameState.lastSpawnTime = 0;
                window.rhythmGameState.lastFrameTime = 0;
                
                // 更新显示
                elements.scoreDisplay.textContent = '0';
                elements.comboDisplay.textContent = '0';
                elements.timeDisplay.textContent = '00:00';
                
                // 清除所有音符和判定文本
                document.querySelectorAll('.note').forEach(note => note.remove());
                document.querySelectorAll('.judge-text').forEach(text => text.remove());
                
                // 开始游戏循环
                window.rhythmGameState.animationFrameId = requestAnimationFrame(gameLoop);
                
                // 开始计时
                window.rhythmGameState.timer = setInterval(() => {
                    window.rhythmGameState.time++;
                    updateTimeDisplay();
                    
                    if (window.rhythmGameState.time >= window.rhythmGameState.gameDuration) {
                        endGame();
                    }
                }, 1000);
                
                // 窗口大小变化时重新计算位置
                window.addEventListener('resize', setupHitElements);
            }

            // 更新时间显示
            function updateTimeDisplay() {
                const minutes = Math.floor(window.rhythmGameState.time / 60);
                const seconds = window.rhythmGameState.time % 60;
                elements.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // 生成新音符 - 确保同轨道音符有足够间距
            function spawnNote(timestamp) {
                if (!window.rhythmGameState.isPlaying) return;
                
                if (timestamp - window.rhythmGameState.lastSpawnTime > window.rhythmGameState.spawnInterval) {
                    window.rhythmGameState.lastSpawnTime = timestamp;
                    
                    // 随机选择一个轨道
                    const trackIndex = Math.floor(Math.random() * window.rhythmGameState.trackCount);
                    const trackElement = elements.tracks[trackIndex];
                    
                    // 检查同轨道最近的音符，确保有足够间距
                    const trackNotes = Array.from(window.rhythmGameState.notes.values()).filter(note => 
                        !note.hit && note.trackIndex === trackIndex
                    );
                    
                    // 只在有足够空间时生成新音符（至少100px间距）
                    const canSpawn = trackNotes.length === 0 || 
                                    Math.min(...trackNotes.map(n => n.y)) > 100;
                    
                    if (canSpawn) {
                        // 创建带判定区域标记的音符
                        const { element: noteElement, id: noteId } = createNoteWithJudgeZones(trackIndex);
                        
                        // 添加到轨道
                        trackElement.appendChild(noteElement);
                        
                        // 记录音符信息到Map
                        window.rhythmGameState.notes.set(noteId, {
                            id: noteId,
                            element: noteElement,
                            trackIndex,
                            y: -window.rhythmGameState.noteRadius * 2, // 初始位置在游戏区域外
                            hit: false
                        });
                    }
                }
            }

            // 更新音符位置
            function updateNotes(timestamp) {
                if (!window.rhythmGameState.isPlaying) return;
                
                // 计算与上一帧的时间差（秒）
                const deltaTime = window.rhythmGameState.lastFrameTime ? (timestamp - window.rhythmGameState.lastFrameTime) / 1000 : 0;
                
                // 迭代所有音符的副本，避免修改正在迭代的Map
                Array.from(window.rhythmGameState.notes.values()).forEach(note => {
                    if (note.hit) return;
                    
                    // 基于时间差计算移动距离，确保速度稳定
                    const distanceToMove = window.rhythmGameState.noteSpeed * deltaTime;
                    note.y += distanceToMove;
                    note.element.style.top = `${note.y}px`;
                    
                    // 检查是否应该自动判定为Miss
                    const autoJudge = checkNoteIntersection(note, timestamp);
                    if (autoJudge === 'miss') {
                        note.hit = true;
                        judgeNote(note, 'miss');
                        
                        // 应用消失动画
                        note.element.classList.add('note-disappear', 'bg-danger', 'opacity-50');
                        
                        // 动画结束后移除元素并从Map中删除
                        setTimeout(() => {
                            if (note.element && note.element.parentNode) {
                                note.element.parentNode.removeChild(note.element);
                            }
                            window.rhythmGameState.notes.delete(note.id);
                        }, 300);
                    }
                });
                
                window.rhythmGameState.lastFrameTime = timestamp;
            }

            // 检查音符与判定线的交叉情况
            function checkNoteIntersection(note, timestamp) {
                // 如果音符底部已经超过判定线下方一定距离，则判定为Miss
                if (note.y - window.rhythmGameState.noteRadius > window.rhythmGameState.hitLineY + window.rhythmGameState.noteRadius * 1.5) {
                    return 'miss';
                }
                return null;
            }

            // 判定音符
            function judgeNote(note, forcedType = null) {
                let type;
                
                if (forcedType) {
                    type = forcedType;
                } else {
                    // 计算音符与判定线的距离比例
                    const distance = Math.abs(note.y - window.rhythmGameState.hitLineY);
                    const distanceRatio = distance / window.rhythmGameState.noteRadius;
                    
                    // 判定结果
                    if (distanceRatio < (1 - window.rhythmGameState.hitWindow.perfect)) {
                        type = 'perfect';
                    } else if (distanceRatio < (1 - window.rhythmGameState.hitWindow.good)) {
                        type = 'good';
                    } else {
                        type = 'miss';
                    }
                }
                
                // 更新判定计数
                window.rhythmGameState.judgeCounts[type]++;
                
                // 显示判定文本
                showJudgeText(type, note.trackIndex);
                
                // 判定点闪烁动画
                elements.judgePoints[note.trackIndex].style.animation = 'none';
                elements.judgePoints[note.trackIndex].offsetHeight; // 触发重绘
                elements.judgePoints[note.trackIndex].style.animation = 'judgePointPulse 0.5s';
                
                // 更新分数和连击
                switch(type) {
                    case 'perfect':
                        window.rhythmGameState.score += 10 * (1 + window.rhythmGameState.combo / 10);
                        window.rhythmGameState.combo++;
                        // 显示小人1.png
                        switchAvatarImage('../image/小人1.png');
                        break;
                    case 'good':
                        window.rhythmGameState.score += 5 * (1 + window.rhythmGameState.combo / 20);
                        window.rhythmGameState.combo++;
                        // 显示小人1.png
                        switchAvatarImage('../image/小人1.png');
                        break;
                    case 'miss':
                        window.rhythmGameState.combo = 0;
                        // 切换小人图片为小人2.png
                        switchAvatarImage('../image/小人2.png');
                        break;
                }
                
                // 更新最大连击
                if (window.rhythmGameState.combo > window.rhythmGameState.maxCombo) {
                    window.rhythmGameState.maxCombo = window.rhythmGameState.combo;
                    elements.comboDisplay.classList.add('combo-pulse');
                    setTimeout(() => {
                        elements.comboDisplay.classList.remove('combo-pulse');
                    }, 300);
                }
                
                // 更新显示
                elements.scoreDisplay.textContent = Math.floor(window.rhythmGameState.score);
                elements.comboDisplay.textContent = window.rhythmGameState.combo;
            }

            // 在按键上方显示判定文本
            function showJudgeText(type, trackIndex) {
                const judgeDisplay = elements.keyContainers[trackIndex].querySelector('.judge-display');
                
                // 创建判定文本元素
                const textElement = document.createElement('div');
                textElement.className = `judge-text judge-popup`;
                
                // 设置文本和样式
                switch(type) {
                    case 'perfect':
                        textElement.textContent = 'PERFECT';
                        textElement.classList.add('text-success');
                        break;
                    case 'good':
                        textElement.textContent = 'GOOD';
                        textElement.classList.add('text-warning');
                        break;
                    case 'miss':
                        textElement.textContent = 'MISS';
                        textElement.classList.add('text-danger');
                        break;
                }
                
                // 添加到DOM
                judgeDisplay.appendChild(textElement);
                
                // 动画结束后移除
                setTimeout(() => {
                    textElement.remove();
                }, 1000);
            }

            // 处理按键按下
            function handleKeyDown(e) {
                if (!window.rhythmGameState.isPlaying) return;
                
                const trackIndex = window.rhythmGameState.keyMap[e.key.toLowerCase()];
                if (trackIndex === undefined) return;
                
                // 按键动画
                const keyElement = elements.keys[trackIndex];
                keyElement.classList.add('key-active');
                setTimeout(() => {
                    keyElement.classList.remove('key-active');
                }, 100);
                
                // 查找当前轨道上可击中的音符，按与判定线的距离排序
                const hittableNotes = Array.from(window.rhythmGameState.notes.values())
                    .filter(note => 
                        !note.hit && 
                        note.trackIndex === trackIndex &&
                        // 只考虑与判定线有交叉的音符
                        (note.y - window.rhythmGameState.noteRadius < window.rhythmGameState.hitLineY + window.rhythmGameState.noteRadius &&
                         note.y + window.rhythmGameState.noteRadius > window.rhythmGameState.hitLineY - window.rhythmGameState.noteRadius)
                    )
                    .sort((a, b) => {
                        // 按与判定线的距离排序
                        const distanceA = Math.abs(a.y - window.rhythmGameState.hitLineY);
                        const distanceB = Math.abs(b.y - window.rhythmGameState.hitLineY);
                        return distanceA - distanceB;
                    });
                
                // 只击中最接近判定线的那个音符
                if (hittableNotes.length > 0) {
                    const noteToHit = hittableNotes[0];
                    noteToHit.hit = true;
                    judgeNote(noteToHit);
                    
                    // 添加击中动画和消失效果
                    const isPerfect = Math.abs(noteToHit.y - window.rhythmGameState.hitLineY) < 
                                     window.rhythmGameState.noteRadius * (1 - window.rhythmGameState.hitWindow.perfect);
                    
                    noteToHit.element.classList.add(isPerfect ? 'bg-success' : 'bg-warning');
                    noteToHit.element.classList.add('note-hit', 'note-disappear');
                    
                    // 动画结束后移除元素并从Map中删除
                    setTimeout(() => {
                        if (noteToHit.element && noteToHit.element.parentNode) {
                            noteToHit.element.parentNode.removeChild(noteToHit.element);
                        }
                        window.rhythmGameState.notes.delete(noteToHit.id);
                    }, 300);
                }
            }

            // 游戏主循环
            function gameLoop(timestamp) {
                if (!window.rhythmGameState.isPlaying) return;
                
                // 生成音符
                spawnNote(timestamp);
                
                // 更新音符位置
                updateNotes(timestamp);
                
                // 继续循环
                window.rhythmGameState.animationFrameId = requestAnimationFrame(gameLoop);
            }

            // 结束游戏
            function endGame() {
                window.rhythmGameState.isPlaying = false;
                clearInterval(window.rhythmGameState.timer);
                if (window.rhythmGameState.animationFrameId) {
                    cancelAnimationFrame(window.rhythmGameState.animationFrameId);
                }
                window.removeEventListener('resize', setupHitElements);
                
                // 计算准确率
                const totalNotes = window.rhythmGameState.judgeCounts.perfect + window.rhythmGameState.judgeCounts.good + window.rhythmGameState.judgeCounts.miss;
                const accuracy = totalNotes > 0 
                    ? Math.round((window.rhythmGameState.judgeCounts.perfect + window.rhythmGameState.judgeCounts.good) / totalNotes * 100) 
                    : 0;
                
                // 更新游戏结束界面
                elements.finalScore.textContent = Math.floor(window.rhythmGameState.score);
                elements.maxCombo.textContent = window.rhythmGameState.maxCombo;
                elements.perfectCount.textContent = window.rhythmGameState.judgeCounts.perfect;
                elements.goodCount.textContent = window.rhythmGameState.judgeCounts.good;
                elements.missCount.textContent = window.rhythmGameState.judgeCounts.miss;
                elements.accuracy.textContent = `${accuracy}%`;
                
                // 显示游戏结束界面
                elements.gameOver.classList.remove('hidden');
            }

            // 切换小人图片
            function switchAvatarImage(imageSrc) {
                const avatarImage = document.getElementById('avatar-image');
                if (avatarImage) {
                    avatarImage.src = imageSrc;
                    
                    // 如果是切换到小人2.png，则0.2秒后切换回小人1.png
                    if (imageSrc.includes('小人2.png')) {
                        setTimeout(() => {
                            if (avatarImage.src.includes('小人2.png')) {
                                avatarImage.src = '../image/小人1.png';
                            }
                        }, 200);
                    }
                }
            }

            // 初始化小人头像
            function initAvatar() {
                // 确保默认显示小人1.png
                const avatarImage = document.getElementById('avatar-image');
                if (avatarImage && !avatarImage.src.includes('小人1.png')) {
                    avatarImage.src = '../image/小人1.png';
                }
            }

            // 事件监听
            elements.startButton.addEventListener('click', () => {
                elements.startMenu.classList.add('opacity-0');
                setTimeout(() => {
                    elements.startMenu.classList.add('hidden');
                    initGame();
                }, 500);
            });

            elements.restartButton.addEventListener('click', () => {
                elements.gameOver.classList.add('hidden');
                initGame();
            });

            // 键盘事件
            document.addEventListener('keydown', handleKeyDown);
        }
        
        // 点击方块挑战游戏逻辑
        function initClickGame() {
            // 防止重复初始化
            if (window.clickInitialized) return;
            window.clickInitialized = true;
            
            // 游戏状态变量
            window.clickGameState = {
                currentScore: 0,
                totalTargets: 64,
                timerInterval: null,
                currentTime: 0,
                bestTime: localStorage.getItem('clickGameBestTime') || null,
                target: null // 当前目标方块
            };
            
            // DOM 元素
            const elements = {
                scoreDisplay: document.getElementById('score-display'),
                timeDisplay: document.getElementById('time-click'),
                bestTimeDisplay: document.getElementById('best-time-click'),
                gameArea: document.getElementById('game-area-click'),
                completeMessage: document.getElementById('complete-message'),
                startMessage: document.getElementById('start-message'),
                nextButton: document.getElementById('next-click-game')
            };
            
            // 窗口大小改变时重新计算游戏区域
            window.addEventListener('resize', function() {
                // 如果有当前方块，重新定位它以确保在可视区域内
                if (window.clickGameState && window.clickGameState.target) {
                    const gameAreaRect = elements.gameArea.getBoundingClientRect();
                    const areaWidth = gameAreaRect.width;
                    const areaHeight = gameAreaRect.height;
                    
                    // 方块尺寸
                    const targetSize = 64;
                    
                    // 获取当前方块的位置
                    const currentLeft = parseFloat(window.clickGameState.target.style.left);
                    const currentTop = parseFloat(window.clickGameState.target.style.top);
                    
                    // 确保方块在游戏区域内
                    const newLeft = Math.min(Math.max(currentLeft, 0), areaWidth - targetSize);
                    const newTop = Math.min(Math.max(currentTop, 0), areaHeight - targetSize);
                    
                    // 更新方块位置
                    window.clickGameState.target.style.left = `${newLeft}px`;
                    window.clickGameState.target.style.top = `${newTop}px`;
                }
            });
            
            // 初始化最佳时间显示
            updateBestTimeDisplay();
            
            // 创建目标方块
            function createTarget() {
                // 移除现有方块
                if (window.clickGameState.target) {
                    window.clickGameState.target.remove();
                    window.clickGameState.target = null;
                }
                
                // 如果游戏已完成，不创建新方块
                if (window.clickGameState.currentScore >= window.clickGameState.totalTargets) {
                    return;
                }
                
                // 创建新方块
                const target = document.createElement('div');
                target.className = 'target-square bg-primary rounded-md shadow-md';
                
                // 计算游戏区域的可用范围
                const gameAreaRect = elements.gameArea.getBoundingClientRect();
                const areaWidth = gameAreaRect.width;
                const areaHeight = gameAreaRect.height;
                
                // 方块尺寸
                const targetSize = 64; // 16rem是64px
                
                // 确保方块完全在游戏区域内
                const maxX = areaWidth - targetSize;
                const maxY = areaHeight - targetSize;
                
                // 在整个游戏区域内随机位置
                const randomX = Math.floor(Math.random() * maxX);
                const randomY = Math.floor(Math.random() * maxY);
                
                // 设置方块位置
                target.style.left = `${randomX}px`;
                target.style.top = `${randomY}px`;
                
                // 添加点击事件
                target.addEventListener('click', handleTargetClick);
                
                // 防止默认行为（如缩放、拖拽等）
                target.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                });
                
                // 添加到游戏区域
                elements.gameArea.appendChild(target);
                window.clickGameState.target = target;
                
                // 随机颜色变化增加趣味性
                const colors = ['bg-primary', 'bg-secondary', 'bg-accent', 'bg-red-500', 'bg-purple-500'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                target.className = `target-square ${randomColor} rounded-md shadow-md`;
            }
            
            // 处理方块点击
            function handleTargetClick(e) {
                e.stopPropagation(); // 防止触发游戏区域的点击事件
                
                // 如果是第一次点击，开始计时
                if (!window.clickGameState.gameStarted) {
                    window.clickGameState.gameStarted = true;
                    window.clickGameState.startTime = performance.now();
                    window.clickGameState.timerInterval = setInterval(updateTimer, 10);
                    elements.startMessage.style.opacity = '0'; // 隐藏开始提示
                }
                
                // 增加分数
                window.clickGameState.currentScore++;
                updateScoreDisplay();
                
                // 检查游戏是否结束
                if (window.clickGameState.currentScore >= window.clickGameState.totalTargets) {
                    endGame();
                    return;
                }
                
                // 创建新的目标方块
                createTarget();
            }
            
            // 更新分数显示
            function updateScoreDisplay() {
                elements.scoreDisplay.textContent = `${window.clickGameState.currentScore}/${window.clickGameState.totalTargets}`;
                
                // 添加分数变化动画
                elements.scoreDisplay.classList.add('scale-110', 'text-secondary');
                setTimeout(() => {
                    elements.scoreDisplay.classList.remove('scale-110', 'text-secondary');
                }, 200);
            }
            
            // 更新计时器
            function updateTimer() {
                if (!window.clickGameState.gameStarted) return;
                
                const currentTimeMs = performance.now() - window.clickGameState.startTime;
                window.clickGameState.currentTime = currentTimeMs / 1000;
                elements.timeDisplay.textContent = window.clickGameState.currentTime.toFixed(3);
            }
            
            // 更新最佳时间显示
            function updateBestTimeDisplay() {
                if (window.clickGameState.bestTime) {
                    elements.bestTimeDisplay.textContent = parseFloat(window.clickGameState.bestTime).toFixed(3);
                } else {
                    elements.bestTimeDisplay.textContent = '--';
                }
            }
            
            // 结束游戏
            function endGame() {
                clearInterval(window.clickGameState.timerInterval);
                window.clickGameState.gameStarted = false;
                
                // 移除最后一个方块
                if (window.clickGameState.target) {
                    window.clickGameState.target.remove();
                    window.clickGameState.target = null;
                }
                
                // 显示完成消息
                elements.completeMessage.style.opacity = '1';
                
                // 显示下一个游戏按钮
                elements.nextButton.classList.remove('hidden');
                
                // 检查是否创造了新的最佳记录
                if (!window.clickGameState.bestTime || window.clickGameState.currentTime < parseFloat(window.clickGameState.bestTime)) {
                    window.clickGameState.bestTime = window.clickGameState.currentTime.toString();
                    localStorage.setItem('clickGameBestTime', window.clickGameState.bestTime);
                    updateBestTimeDisplay();
                }
            }
            
            // 重置游戏
            function resetGame() {
                window.clickGameState.currentScore = 0;
                updateScoreDisplay();
                elements.timeDisplay.textContent = '0.000';
                elements.completeMessage.style.opacity = '0';
                elements.startMessage.style.opacity = '1';
                elements.nextButton.classList.add('hidden');
                createTarget();
            }
            
            // 为游戏区域添加点击事件，用于重置游戏和开始游戏
            elements.gameArea.addEventListener('click', () => {
                // 如果游戏已完成，重置游戏
                if (window.clickGameState.currentScore >= window.clickGameState.totalTargets) {
                    resetGame();
                } 
                // 如果游戏未开始，创建第一个目标
                else if (!window.clickGameState.gameStarted && window.clickGameState.currentScore === 0) {
                    createTarget();
                    elements.startMessage.style.opacity = '0';
                }
            });
        }
        
        // 打地鼠游戏逻辑
        function initWhackAMole() {
            // 防止重复初始化
            if (window.whackInitialized) return;
            window.whackInitialized = true;
            
            // 游戏状态
            window.whackGameState = {
                isPlaying: false,
                score: 0,
                correctClicks: 0,  // 正确点击次数
                wrongClicks: 0,    // 错误点击次数
                target: 64,
                timeLeft: 32,
                activeSquares: [], // 存储所有当前亮着的方块索引
                timerInterval: null,
                spawnInterval: null // 用于定期添加新的亮方块
            };
            
            // DOM 元素
            const squares = document.querySelectorAll('.square');
            const startButton = document.getElementById('start-button-whack');
            const restartButton = document.getElementById('restart-button-whack');
            const scoreDisplay = document.getElementById('score-whack');
            const timeDisplay = document.getElementById('time-whack');
            const finalScoreDisplay = document.getElementById('final-score-whack');
            const resultMessageDisplay = document.getElementById('result-message-whack');
            const gameOverModal = document.getElementById('game-over-modal-whack');
            
            // 初始化游戏
            function initGame() {
                // 重置游戏状态
                window.whackGameState.isPlaying = false;
                window.whackGameState.score = 0;
                window.whackGameState.correctClicks = 0;  // 重置正确点击次数
                window.whackGameState.wrongClicks = 0;    // 重置错误点击次数
                window.whackGameState.timeLeft = 32;
                window.whackGameState.activeSquares = [];
                
                // 更新 UI
                scoreDisplay.textContent = window.whackGameState.score;
                timeDisplay.textContent = window.whackGameState.timeLeft;
                
                // 重置方块状态
                squares.forEach(function(square) {
                    square.classList.remove('square-active');
                    square.classList.add('square-normal');
                    // 确保移除所有内联样式
                    square.style.backgroundColor = '';
                    square.style.boxShadow = '';
                });
                
                // 隐藏游戏结束弹窗
                gameOverModal.classList.add('hidden');
                gameOverModal.style.display = 'none';
                
                // 显示开始按钮
                startButton.classList.remove('hidden');
                
                // 清除所有定时器
                if (window.whackGameState.timerInterval) clearInterval(window.whackGameState.timerInterval);
                if (window.whackGameState.spawnInterval) clearInterval(window.whackGameState.spawnInterval);
            }
            
            // 开始游戏
            function startGame() {
                // 如果游戏已经在进行中，不执行操作
                if (window.whackGameState.isPlaying) return;
                
                // 设置游戏状态
                window.whackGameState.isPlaying = true;
                window.whackGameState.score = 0;
                window.whackGameState.correctClicks = 0;  // 重置正确点击次数
                window.whackGameState.wrongClicks = 0;    // 重置错误点击次数
                window.whackGameState.timeLeft = 32;
                window.whackGameState.activeSquares = [];
                
                // 更新 UI
                scoreDisplay.textContent = window.whackGameState.score;
                timeDisplay.textContent = window.whackGameState.timeLeft;
                
                // 隐藏开始按钮
                startButton.classList.add('hidden');
                
                // 启动计时器
                window.whackGameState.timerInterval = setInterval(updateTimer, 1000);
                
                // 启动方块生成器 - 每0.5秒添加一个新的亮方块
                window.whackGameState.spawnInterval = setInterval(addNewActiveSquare, 500);
                
                // 立即添加第一个亮方块
                addNewActiveSquare();
            }
            
            // 更新计时器
            function updateTimer() {
                window.whackGameState.timeLeft--;
                timeDisplay.textContent = window.whackGameState.timeLeft;
                
                // 检查游戏是否结束
                if (window.whackGameState.timeLeft <= 0) {
                    endGame();
                }
            }
            
            // 添加一个新的亮方块
            function addNewActiveSquare() {
                // 如果游戏未进行中，不执行操作
                if (!window.whackGameState.isPlaying) return;
                
                // 如果所有方块都已经亮着，不再添加新的
                if (window.whackGameState.activeSquares.length >= squares.length) {
                    return;
                }
                
                // 随机选择一个未亮的方块
                const availableSquares = [];
                for (let i = 0; i < squares.length; i++) {
                    if (window.whackGameState.activeSquares.indexOf(i) === -1) {
                        availableSquares.push(i);
                    }
                }
                
                if (availableSquares.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableSquares.length);
                    const newActiveSquare = availableSquares[randomIndex];
                    
                    // 激活新的方块
                    activateSquare(newActiveSquare);
                }
            }
            
            // 激活指定方块
            function activateSquare(index) {
                // 如果方块已经亮着，不执行操作
                if (window.whackGameState.activeSquares.indexOf(index) !== -1) return;
                
                // 添加到活跃方块列表
                window.whackGameState.activeSquares.push(index);
                
                // 更新方块样式
                const square = squares[index];
                square.classList.remove('square-normal');
                square.classList.add('square-active');
            }
            
            // 取消激活指定方块
            function deactivateSquare(index) {
                // 从活跃方块列表中移除
                const squareIndex = window.whackGameState.activeSquares.indexOf(index);
                if (squareIndex !== -1) {
                    window.whackGameState.activeSquares.splice(squareIndex, 1);
                }
                
                // 更新方块样式
                const square = squares[index];
                square.classList.remove('square-active');
                square.classList.add('square-normal');
            }
            
            // 处理方块点击
            function handleSquareClick(index) {
                // 如果游戏未进行中，不执行操作
                if (!window.whackGameState.isPlaying) return;
                
                // 如果点击的是亮着的方块（正确方块）
                if (window.whackGameState.activeSquares.indexOf(index) !== -1) {
                    // 增加正确点击次数
                    window.whackGameState.correctClicks++;
                    
                    // 增加分数（点击正确方块次数越多，分数越高）
                    window.whackGameState.score =  window.whackGameState.score + 1;
                    scoreDisplay.textContent = window.whackGameState.correctClicks;
                    
                    // 视觉反馈 - 成功点击，方块变暗
                    deactivateSquare(index);
                    
                    // 检查是否完成目标
                    if (window.whackGameState.correctClicks >= window.whackGameState.target) {
                        endGame();
                    }
                } 
                // 如果点击的是灰色方块（错误方块）
                else {
                    // 增加错误点击次数
                    window.whackGameState.wrongClicks++;
                    
                    // 减少分数（点击灰色方块次数越多，分数越低）
                    window.whackGameState.score =  window.whackGameState.score - 1;
                    scoreDisplay.textContent = window.whackGameState.correctClicks;
                }
            }
            
            // 结束游戏
            function endGame() {
                // 设置游戏状态
                window.whackGameState.isPlaying = false;
                
                // 清除所有定时器
                clearInterval(window.whackGameState.timerInterval);
                clearInterval(window.whackGameState.spawnInterval);
                
                // 取消所有激活的方块
                window.whackGameState.activeSquares.forEach(function(index) {
                    deactivateSquare(index);
                });
                
                // 更新最终得分
                finalScoreDisplay.textContent = window.whackGameState.correctClicks;
                
                // 设置结果消息
                if (window.whackGameState.correctClicks >= window.whackGameState.target) {
                    resultMessageDisplay.textContent = '太棒了！你完成了挑战！';
                    resultMessageDisplay.className = 'text-lg mb-6 text-green-600 font-bold';
                } else {
                    resultMessageDisplay.textContent = '继续努力，争取下次完成挑战！';
                    resultMessageDisplay.className = 'text-lg mb-6 text-gray-600';
                }
                
                // 显示游戏结束弹窗
                gameOverModal.classList.remove('hidden');
                gameOverModal.style.display = 'flex';
            }
            
            // 添加事件监听器
            startButton.onclick = function() {
                startGame();
            };
            
            // Explicitly add event listener to restart button to ensure it works
            restartButton.addEventListener('click', function() {
                console.log('Whack-a-mole restart button clicked');
                // Call the global completeCurrentGame function
                if (typeof completeCurrentGame === 'function') {
                    completeCurrentGame();
                } else {
                    console.error('completeCurrentGame function not found');
                    // Fallback to initGame if the global function is not accessible
                    initGame();
                }
            });
            
            squares.forEach(function(square, index) {
                square.onclick = function() {
                    handleSquareClick(index);
                };
            });
            
            // 初始化游戏
            initGame();
        }
        
        // 打字练习游戏逻辑
        function initTypingPractice() {
            // 防止重复初始化
            if (window.typingInitialized) return;
            window.typingInitialized = true;
            
            // 游戏状态
            window.typingGameState = {
                startTime: null,
                timerInterval: null,
                isTyping: false
            };
            
            // 获取DOM元素
            const originalTargetText = document.getElementById('target-text').textContent.trim();
            const targetTextElement = document.getElementById('target-text');
            const typingInput = document.getElementById('typing-input');
            const currentTimeEl = document.getElementById('current-time');
            const bestRecordEl = document.getElementById('best-record-typing');
            const nextButton = document.getElementById('next-typing-game');
            
            // 时间格式化（分:秒.毫秒）
            window.formatTime = function(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                const milliseconds = Math.floor((ms % 1000) / 10);
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
            };
            
            // 初始化：从本地存储读取最快纪录
            function initBestRecord() {
                const savedRecord = localStorage.getItem('typingBestTime');
                if (savedRecord) {
                    bestRecordEl.textContent = window.formatTime(parseFloat(savedRecord));
                }
            }
            
            // 开始计时
            function startTimer() {
                if (window.typingGameState.isTyping) return;
                window.typingGameState.isTyping = true;
                window.typingGameState.startTime = Date.now();
                window.typingGameState.timerInterval = setInterval(() => {
                    const elapsedTime = Date.now() - window.typingGameState.startTime;
                    currentTimeEl.textContent = window.formatTime(elapsedTime);
                }, 10);
            }
            
            // 结束计时并检查是否刷新纪录
            function endTimer() {
                clearInterval(window.typingGameState.timerInterval);
                const totalTime = Date.now() - window.typingGameState.startTime;
                currentTimeEl.textContent = window.formatTime(totalTime);
                window.typingGameState.isTyping = false;
                
                // 显示下一个游戏按钮
                nextButton.classList.remove('hidden');
                
                // 保存本次用时，供分数统计使用
                window.typingGameState.lastDuration = totalTime; // ms
                
                // 检查是否刷新最快纪录
                const savedRecord = localStorage.getItem('typingBestTime');
                if (!savedRecord || totalTime < parseFloat(savedRecord)) {
                    localStorage.setItem('typingBestTime', totalTime.toString());
                    bestRecordEl.textContent = window.formatTime(totalTime);
                }
            }
            
            // 实时更新文本高亮显示
            window.updateTextHighlight = function() {
                const inputContent = typingInput.value;
                let highlightedText = '';
                
                // 遍历每个字符进行比较
                for (let i = 0; i < originalTargetText.length; i++) {
                    const originalChar = originalTargetText[i];
                    const inputChar = inputContent[i];
                    
                    if (i >= inputContent.length) {
                        // 尚未输入的部分
                        highlightedText += `<span class="remaining">${originalChar}</span>`;
                    } else if (originalChar === inputChar) {
                        // 输入正确的部分
                        highlightedText += `<span class="correct">${originalChar}</span>`;
                    } else {
                        // 输入错误的部分
                        highlightedText += `<span class="error">${originalChar}</span>`;
                    }
                }
                
                targetTextElement.innerHTML = highlightedText;
            }
            
            // 检查输入内容
            function checkInput() {
                const inputContent = typingInput.value;
                
                // 输入开始时启动计时器
                if (inputContent.length === 1 && !window.typingGameState.isTyping) {
                    startTimer();
                }
                
                // 更新文本高亮显示
                window.updateTextHighlight();
                
                // 输入内容与目标文本完全一致时结束计时
                if (inputContent === originalTargetText) {
                    endTimer();
                    typingInput.disabled = true;
                }
            }
            
            // 重置游戏
            function resetGame() {
                typingInput.value = '';
                typingInput.disabled = false;
                currentTimeEl.textContent = '00:00.00';
                window.updateTextHighlight();
                nextButton.classList.add('hidden');
                window.typingGameState.isTyping = false;
                if (window.typingGameState.timerInterval) {
                    clearInterval(window.typingGameState.timerInterval);
                }
            }
            
            // 绑定事件
            typingInput.addEventListener('input', checkInput);
            nextButton.addEventListener('click', resetGame);
            
            // 初始化
            initBestRecord();
            window.updateTextHighlight(); // 初始化高亮显示
        }
    </script>
</body>
</html>

                
